{"version":3,"file":"feed.js","sources":["../../../src/routes/feed.tsx?pick=default&pick=$css"],"sourcesContent":["import {\n  For,\n  Show,\n  createEffect,\n  createSignal,\n  useContext,\n  Suspense,\n  createMemo,\n  onCleanup,\n} from \"solid-js\";\nimport { Spinner } from \"~/components/PlayerContainer\";\nimport { RelatedStream } from \"~/types\";\nimport { createQuery, isServer } from \"@tanstack/solid-query\";\nimport { useSyncStore } from \"~/stores/syncStore\";\nimport { ErrorComponent } from \"~/components/Error\";\nimport useIntersectionObserver from \"~/hooks/useIntersectionObserver\";\nimport EmptyState from \"~/components/EmptyState\";\nimport { A } from \"@solidjs/router\";\nimport { useAppState } from \"~/stores/appStateStore\";\nimport { usePreferences } from \"~/stores/preferencesStore\";\nimport { Tooltip } from \"@kobalte/core\";\nimport { FaSolidArrowsRotate } from \"solid-icons/fa\";\nimport { lazy } from \"solid-js\";\nimport { memo } from \"solid-js/web\";\nimport Button from \"~/components/Button\";\nimport VideoCard from \"~/components/content/stream/VideoCard\";\nimport { Title } from \"@solidjs/meta\";\n\nexport default function Feed() {\n  const [limit, setLimit] = createSignal(10);\n  const [preferences] = usePreferences();\n  const sync = useSyncStore();\n  const query = createQuery<RelatedStream[]>(() => ({\n    queryKey: [\"feed\", preferences.instance.api_url, sync.store.subscriptions],\n    queryFn: async (): Promise<RelatedStream[]> => {\n      const res = await fetch(\n        preferences.instance.api_url + \"/feed/unauthenticated\",\n        {\n          method: \"POST\",\n          body: JSON.stringify(Object.keys(sync.store.subscriptions)),\n        }\n      );\n      if (!res.ok) {\n        throw new Error(\"Error fetching feed\");\n      }\n      return res.json() as Promise<RelatedStream[]>;\n    },\n    enabled:\n      preferences.instance?.api_url &&\n      Object.keys(sync.store.subscriptions).length > 0\n        ? true\n        : false,\n    placeholderData: Array(50).fill(undefined),\n    refetchOnMount: true,\n    refetchOnReconnect: true,\n  }));\n\n  const [intersectionRef, setIntersectionRef] = createSignal<\n    HTMLDivElement | undefined\n  >();\n  const isIntersecting = useIntersectionObserver({\n    setTarget: () => intersectionRef(),\n  });\n  createEffect(() => {\n    if (isIntersecting()) {\n      setLimit((l) => l + 10);\n    }\n  });\n  const [appState, setAppState] = useAppState();\n  createEffect(() => {\n    console.log(\n      sync.store.subscriptions,\n      Object.keys(sync.store.subscriptions),\n      \"feed\"\n    );\n    setAppState({\n      loading: query.isRefetching || query.isFetching,\n    });\n  });\n  createEffect(() => {\n    console.log(query.data, \"feed\");\n  });\n\n  const newComponent = (\n    <>\n      <Suspense fallback={<Spinner />}>\n        <Tooltip.Root>\n          <Tooltip.Trigger\n            class=\"fixed bottom-20 sm:bottom-10 right-10 rounded-full w-10 h-10 bg-primary z-50 flex items-center justify-center\"\n            onClick={() => {\n              if (!query.isFetching) {\n                query.refetch();\n              }\n            }}\n          >\n            <FaSolidArrowsRotate fill=\"currentColor\" class=\"w-6 h-6\" />\n          </Tooltip.Trigger>\n          <Tooltip.Portal>\n            <Tooltip.Content class=\"p-2 bg-bg2 rounded max-w-[min(calc(100vw-16px),380px)] animate-[contentHide] data-[expanded]:animate-[contentShow]\">\n              <Tooltip.Arrow />\n              <p>Refresh (Shift + R)</p>\n            </Tooltip.Content>\n          </Tooltip.Portal>\n        </Tooltip.Root>\n        <Title>Feed | Conduit</Title>\n\n        <Show when={!Object.keys(sync.store.subscriptions).length}>\n          <div class=\"h-[80vh] w-full flex items-center justify-center\">\n            <EmptyState message=\"You have no subscriptions.\">\n              <Button as=\"a\" label=\"Import\" href=\"/import\" />\n            </EmptyState>\n          </div>\n        </Show>\n        <Show when={Object.keys(sync.store.subscriptions).length}>\n          <div class=\"mx-2 flex flex-wrap gap-2 justify-center\">\n            <Show when={!Array.isArray(query.data)}>\n              <ErrorComponent error={query.data} />\n            </Show>\n            <Show when={query.data && query.data.length > 0}>\n              <For\n                each={query.data\n                  ?.filter(\n                    (item) =>\n                      !sync.store.blocklist[\n                        item?.uploaderUrl?.split(\"/\").pop()!\n                      ]\n                  )\n                  .slice(0, limit())}\n              >\n                {(video) => <VideoCard v={video} />}\n              </For>\n            </Show>\n          </div>\n        </Show>\n        <div ref={setIntersectionRef} class=\"h-20 \" />\n      </Suspense>\n    </>\n  );\n\n  return newComponent;\n}\n"],"names":["Feed","limit","setLimit","createSignal","preferences","usePreferences","sync","useSyncStore","query","createQuery","queryKey","instance","api_url","store","subscriptions","queryFn","res","fetch","method","body","JSON","stringify","Object","keys","ok","Error","json","enabled","length","placeholderData","Array","fill","undefined","refetchOnMount","refetchOnReconnect","intersectionRef","setIntersectionRef","isIntersecting","useIntersectionObserver","setTarget","createEffect","l","appState","setAppState","useAppState","log","loading","isRefetching","isFetching","data","_$createComponent","Suspense","fallback","Spinner","children","Tooltip","onClick","refetch","FaSolidArrowsRotate","_$ssr","_tmpl$","_$ssrHydrationKey","Title","Show","when","_tmpl$2","_$escape","EmptyState","message","Button","as","label","href","_tmpl$3","isArray","ErrorComponent","error","For","each","filter","item","blocklist","uploaderUrl","split","pop","slice","VideoCard","v","video","_tmpl$4"],"mappings":"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"}