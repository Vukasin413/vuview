import{createComponent as t,ssr as d,ssrHydrationKey as m,escape as c,Portal as he,ssrElement as pe,mergeProps as we,ssrAttribute as ve,isServer as ye}from"solid-js/web";import{s as xe,D as be}from"./assets/Description-BLGxa4wz.js";import{createSignal as p,createEffect as $,Show as L,For as q,Switch as ue,Match as W,onMount as Q,onCleanup as G,Suspense as K}from"solid-js";import{A as Y,E as X,ao as me,V as ee,ad as J,F as $e,ap as te,aq as ne}from"./assets/syncStore-DaflpWzS.js";import{L as re,u as Se}from"./assets/Link-ClDVT-6o.js";import{createQuery as N,createInfiniteQuery as ge}from"@tanstack/solid-query";import"numeral";import{P as Fe}from"./assets/PlaylistCard-Ca1MrW3c.js";import{f as fe,h as Ce}from"./assets/routing-CB9zsxEG.js";import{u as Pe}from"./assets/useIntersectionObserver-sC3M1o1b.js";import{g as _e}from"./assets/index-BPtxG8PX.js";import{P as Le}from"./assets/PlaylistItem-DrQzDyGy.js";import"@solid-primitives/date";import"./assets/index-Bhsy5eyg.js";import"./assets/index-wr7A5cEE.js";import"y-webrtc";import"yjs";import"solid-js/store";import"lib0/observable";import"./assets/components-Bl9pqdE7.js";const ae=async(e,a)=>{console.log("Reading manifest file...");const g=await(await e.getFileHandle(a)).getFile();return console.log("Manifest file read."),(await g.text()).split(`
`)},ie=async(e,a)=>{console.log("Rebuilding manifest...",e,a);let r="",g=0;for(let l of a){if(console.log("Processing line...",l),l.includes("{segment}")){const u=await e.getFileHandle(`segment-${g}.ts`);console.log("Getting segment file...",u);const i=await u.getFile(),x=URL.createObjectURL(i);l=l.replace("{segment}",x),g++}r+=`${l}
`}return console.log("Manifest rebuilt.",r),URL.createObjectURL(new Blob([r]))};async function He(e){console.time("manifest generating"),console.log("Getting video data...");const r=await(await navigator.storage.getDirectory()).getDirectoryHandle(e,{create:!1});console.log("Reading video manifest...");const g=await r.getDirectoryHandle("audio"),l=await r.getDirectoryHandle("video"),u=await ae(g,"audio.m3u8"),i=await ae(l,"video.m3u8");console.log("Rebuilding audio manifest...",u);const x=await ie(g,u);console.log("Rebuilding video manifest...",i);const h=await ie(l,i);console.log("Generating master manifest...");const R=await r.getFileHandle("index.m3u8");console.log("master manifest handle",R);const S=await R.getFile();console.log("master manifest file",S);const s=(await S.text()).replace("{audio}",x).replace("{video}",h);return console.log("master manifest content",s),console.timeEnd("manifest generating"),URL.createObjectURL(new Blob([s]))}const Ie=async e=>{console.log("Getting streams...");const a=await navigator.storage.getDirectory();console.log("Storage root:",a);const r=await a.getDirectoryHandle(e,{create:!1});if(console.log("Video directory:",r),!r)return null;const l=await(await r.getFileHandle("streams.json")).getFile();console.log("Streams file:",l);const u=await l.text(),i=JSON.parse(u);if(console.log("Streams:",i),!i)throw new Error("Streams not found");const h=await(await r.getFileHandle("thumbnail")).getFile(),R=URL.createObjectURL(h);console.log("Thumbnail URL:",R);const S=await r.getFileHandle("channel-icon");console.log("Channel icon file handle:",S);const s=await S.getFile(),w=URL.createObjectURL(s);console.log("Channel icon URL:",w);const T=[];i.thumbnailUrl=R,i.uploaderAvatar=w;try{const y=await r.getDirectoryHandle("subtitles",{create:!1});console.log("Subtitles directory:",y);for(const I of i.subtitles){const D=await(await y.getFileHandle(`${I}.srt`)).getFile(),_=URL.createObjectURL(D);T.push({code:I,url:_})}}catch(y){console.log("Error getting subtitles:",y)}T.length>0&&(i.subtitles=T),console.log("Getting preview frames...");let C;try{C=await r.getDirectoryHandle("preview-frames",{create:!1})}catch(y){console.log("Error getting preview frames:",y)}console.log("Preview frames directory:",C);const H=[];let F=0;if(C)try{for(const y of i.previewFrames[1].urls){const P=await(await C.getFileHandle(`${F}`)).getFile(),D=URL.createObjectURL(P);H.push(D),F++}}catch(y){console.log("Error getting preview frames:",y)}return console.log("Preview frames URLs:",H),i.previewFrames[1].urls=H,console.log("Streams:",i),i};var Re=["<div",' class="w-full max-w-max md:max-w-min">',"</div>"];function Te(){const[e,a]=p(void 0),[r]=Y(),[g]=fe();$(()=>{g.v&&a(g.v)});const l=X(),u=N(()=>({queryKey:["streams",e(),r.instance.api_url],queryFn:()=>me.fetchVideo(e(),r.instance.api_url),enabled:!!(e()&&r.instance.api_url),refetchOnReconnect:!1,refetchOnMount:!1,cacheTime:1/0,staleTime:100*60*1e3,deferStream:!0}));return t(L,{get when(){return u.data},get fallback(){return t(q,{get each(){return Array(20).fill(0)},children:()=>t(ee,{})})},get children(){return d(Re,m(),c(t(q,{get each(){return u.data?.relatedStreams.filter(i=>!l.store.blocklist[i?.uploaderUrl?.split("/").pop()])},children:i=>t(ue,{get children(){return[t(W,{get when(){return i.type==="stream"},get children(){return t(ee,{v:i,layout:"sm:grid"})}}),t(W,{get when(){return i.type==="playlist"},get children(){return t(Fe,{item:i})}})]}})})))}})}var qe='<div id="sb-handle" class="py-5 my-0 mx-auto bg-bg1"><div class="w-10 h-1 m-auto bg-bg3 pointer-events-none"></div></div>',De=['<div id="sb-content" class="','" style="','">',"</div>"],Ue=["<div",' id="sb-overlay" class="fixed inset-0 flex items-end pointer-events-none z-[999999]">',"</div>"];const le=50,Ee=.5,Me=e=>{const a=e.variant==="snap",[r,g]=p(window.visualViewport.height),[l,u]=p(!1),[i,x]=p(!1),h=()=>{if(a){const n=e.defaultSnapPoint({maxHeight:r()});if(n!==r())return window.innerHeight-n}return 0},R=n=>a?[0,...e.snapPoints({maxHeight:n}).sort((o,v)=>v-o)]:[],S=({minimum:n,maximum:o,current:v})=>Math.min(Math.max(v,n),o),[s,w]=p(h()),T=()=>{g(window.visualViewport.height)};Q(()=>{window.visualViewport.addEventListener("resize",T)}),G(()=>{window.visualViewport.removeEventListener("resize",T)}),$(()=>{C=R(r())});let C=[],H=0,F=0;const y=new Set(["sb-handle","sb-content"]);let I=0,P=0;const D=n=>{!y.has(n.target.id)&&!V(n)||(I=n.timeStamp,a&&x(!1),H=F=n.touches[0].clientY,n.preventDefault(),n.stopPropagation())},[_,M]=p(1);p(!0);const f=n=>{if(n.target.id!=="sb-handle")return;n.preventDefault();let o=0;const v=n.timeStamp,A=v-I;switch(A>0&&(P=o/A),I=v,e.variant){case"snap":o=n.touches[0].clientY-F,w(z=>S({minimum:0,maximum:r(),current:z+o})),F=n.touches[0].clientY;break;case"default":default:F=n.touches[0].clientY,o=F-H,o>0&&w(o);break}};async function E(n){return new Promise(o=>setTimeout(o,n))}const O=async n=>(await E(100),new Promise(o=>{n===_()?o(!1):o(!0)})),U=async n=>{if(!y.has(n.target.id)&&!V(n))return;let o=0,v=0;const A=n.timeStamp-I,z=F-H,B=-z/A;switch(console.log("swipeVelocity",B,P),e.variant){case"snap":if(n.target.id!=="sb-handle"){if(await O(_())){console.log("isInertialScrolling");return}if(M(Math.max(0,_()-1)),_()>5){console.log("contentScrollTop",_());return}}Math.abs(B)>Ee||Math.abs(z)>le?(o=r()-F+B*2,v=C.reduce((j,k)=>Math.abs(k-o)<Math.abs(j-o)?k:j)):(o=r()-s(),v=C.reduce((j,k)=>Math.abs(k-o)<Math.abs(j-o)?k:j)),v===0&&u(!0),x(!0),w(r()-v);break;case"default":default:F-H>le?u(!0):w(0);break}},V=n=>{let o=n.target;for(;o;){if(o.id==="sb-content")return!0;o=o.parentElement}return!1};let b;return Q(()=>{const n={passive:!1};b.addEventListener("touchstart",D,n),b.addEventListener("touchmove",f,n),b.addEventListener("touchend",U,n),b.addEventListener("touchcancel",U,n),G(()=>{b.removeEventListener("touchstart",D),b.removeEventListener("touchmove",f),b.removeEventListener("touchend",U),b.removeEventListener("touchcancel",U)})}),t(he,{get children(){return d(Ue,m(),pe("div",we({get classList(){return{"w-full bg-bg1 pointer-events-auto":!0,"animate-out slide-out-to-bottom duration-500":l(),"animate-in slide-in-from-bottom ":!l(),"transition-all duration-250":i()}},get style(){return{transform:`translateY(${s()}px)`,...a?{height:`${r()}px`}:{}}}},()=>l()?{onAnimationEnd:e.onClose}:{}),()=>[d(qe),d(De,"relative w-full h-full bg-bg1 overscroll-contain overflow-y-auto",`height:calc(100vh - ${c(s(),!0)}px)`,c(e.children))],!1))}})};var Oe=["<img",' width="48" height="48"',' alt="" class="rounded-full w-full h-full">'],Ve=["<p",' class="text-xs">',"</p>"],je=["<button",' class="underline">Hide replies</button>'],ke=["<div",' class="flex gap-2 "><!--$-->','<!--/--><div class="flex flex-col w-11/12"><span class="flex gap-2 items-center"><!--$-->',"<!--/--><!--$-->",'<!--/--><p class="text-xs text-text2">',"</p></span><!--$-->",'<!--/--><span class="flex gap-1 items-center text-xs "><!--$-->',"<!--/--><!--$-->","<!--/--><!--$-->","<!--/--><!--$-->","<!--/--></span></div></div>"],Ae=["<button",' class="text-xs underline">Load more replies</button>'],ze=["<div",' class="ml-8 my-2">',"</div>"],oe=["<svg",' class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.0001 2.00001C6.47715 2.00001 2.00006 6.4771 2.00006 12C2.00006 17.5229 6.47715 22 12.0001 22C17.5229 22 22 17.5229 22 12C22 6.4771 17.5229 2.00001 12.0001 2.00001ZM12.0001 4.00001C16.4182 4.00001 20.0001 7.58191 20.0001 12C20.0001 16.4181 16.4182 20 12.0001 20C7.58199 20 4.00006 16.4181 4.00006 12C4.00006 7.58191 7.58199 4.00001 12.0001 4.00001ZM11.9999 7.00001C11.4477 7.00001 10.9999 7.44772 10.9999 8.00001V12.0001L8.99994 12.0001C8.44775 12.0001 7.99994 12.4478 7.99994 13.0001C7.99994 13.5523 8.44775 14.0001 8.99994 14.0001L11.9999 14.0001V18.0001C11.9999 18.5523 12.4477 19.0001 12.9999 19.0001C13.5521 19.0001 13.9999 18.5523 13.9999 18.0001V8.00001C13.9999 7.44772 13.5521 7.00001 11.9999 7.00001Z"></path></svg>'],Ne=["<p",">Loading...</p>"],We=["<button",' class="underline">View <!--$-->',"<!--/--> replies</button>"],Ke=["<button",' class="underline">View 1 reply</button>'],Ye=["<div",' class="text-xs">Loading...</div>'];function Z(e){p(!1);const[a,r]=p(!1);p([]),p(null),X();const[g]=Y(),l=async({pageParam:h="initial"})=>h==="initial"?await J(`${g.instance.api_url}/nextpage/comments/${e.videoId}`,{nextpage:e.comment.repliesPage}):await J(`${g.instance.api_url}/nextpage/comments/${e.videoId}`,{nextpage:h}),u=ge(()=>({queryKey:["commentsReplies",e.videoId,g.instance.api_url,e.comment.commentId],queryFn:l,enabled:!!(g.instance?.api_url&&e.videoId&&e.comment.repliesPage&&a()),getNextPageParam:h=>h.nextpage,initialPageParam:"initial"})),[i,x]=p("");return $(async()=>{x(await xe(e.comment.commentText))}),[d(ke,m(),c(t(re,{get href(){return`${e.comment.commentorUrl}`},class:"w-1/12 rounded-full justify-center flex h-fit",get children(){return d(Oe,m(),ve("src",c(e.comment.thumbnail,!0),!1))}})),c(t(re,{get href(){return`${e.comment.commentorUrl}`},get class(){return`text-sm font-bold ${e.comment.commentorUrl===e.uploader&&"bg-background rounded-full px-4"}`},get children(){return e.comment.author}})),e.comment.verified&&oe[0]+m()+oe[1],c(e.comment.commentedTime),c(t(K,{get fallback(){return d(Ne,m())},get children(){return d(Ve,m(),i())}})),c(t(_e,{})),c(e.comment.likeCount),c(t(L,{get when(){return e.comment.replyCount>0&&!a()},get children(){return[e.comment.replyCount>1&&d(We,m(),c(e.comment.replyCount)),e.comment.replyCount===1&&d(Ke,m())]}})),c(t(L,{get when(){return a()},get children(){return d(je,m())}}))),t(L,{get when(){return a()},get children(){return d(ze,m(),c(t(K,{get fallback(){return d(Ye,m())},get children(){return[t(q,{get each(){return u.data?.pages?.flat()?.map(h=>h.comments).flat()},children:h=>t(Z,{comment:h,get uploader(){return e.uploader},get videoId(){return e.videoId},nextpage:""})}),t(L,{get when(){return u.hasNextPage},get children(){return d(Ae,m())}})]}})))}})]}var Be=["<button",' class="text-center text-sm w-full rounded-lg bg-bg2 p-2 mb-2">Comments</button>'],se=["<div",' class="w-full h-40 bg-primary"></div>'],Qe=["<div",' id="sb-content" class="flex flex-col gap-1 relative ">',"</div>"],Ge=["<div",' class="text-text1 bg-bg1 p-2 rounded-t-lg max-w-full overflow-y-auto ">',"</div>"],Je=["<div",' id="sb-content" class="flex flex-col gap-1 relative z-50 ">',"</div>"],ce=["<p",">Loading...</p>"];function de(e){const[a]=Y(),r=async({pageParam:s="initial"})=>s==="initial"?await(await fetch(`${a.instance.api_url}/comments/${e.videoId}`)).json():await J(`${a.instance.api_url}/nextpage/comments/${e.videoId}`,{nextpage:s}),[g,l]=p(0);$(()=>{const s=document.querySelector("media-player");s&&l(s.clientHeight+50)});const u=ge(()=>({queryKey:["comments",e.videoId,a.instance.api_url],queryFn:r,enabled:!!(a.instance?.api_url&&e.videoId),getNextPageParam:s=>s.nextpage,initialPageParam:"initial"})),[i,x]=p(!1),[h,R]=p(void 0),S=Pe({setTarget:()=>h()});return $(()=>{S()&&u.hasNextPage&&u.fetchNextPage()}),t(ue,{get children(){return[t(W,{get when(){return e.display==="bottomsheet"},get children(){return[d(Be,m()),i()&&t(Me,{variant:"snap",defaultSnapPoint:({maxHeight:s})=>s-g(),snapPoints:({maxHeight:s})=>[s-40,s-g()],onClose:()=>{console.log("close"),x(!1)},get children(){return t(K,{get fallback(){return d(ce,m())},get children(){return d(Je,m(),c(t(L,{get when(){return u.data},get children(){return[t(q,{get each(){return u.data.pages},children:s=>t(q,{get each(){return s.comments.filter(w=>w.commentText)},children:w=>t(Z,{get videoId(){return e.videoId},comment:w,get uploader(){return e.uploader},nextpage:""})})}),d(se,m())]}})))}})}})]}}),t(W,{get when(){return e.display==="default"},get children(){return d(Ge,m(),c(t(K,{get fallback(){return d(ce,m())},get children(){return d(Qe,m(),c(t(L,{get when(){return u.data},get children(){return[t(q,{get each(){return u.data.pages},children:s=>t(q,{get each(){return s.comments.filter(w=>w.commentText)},children:w=>t(Z,{get videoId(){return e.videoId},comment:w,get uploader(){return e.uploader},nextpage:""})})}),d(se,m())]}})))}})))}})]}})}var Ze=["<div",' class="h-[calc(100vh-2rem)]"></div>'],Xe=["<div",' class="mx-4">',"</div>"],et=["<div",' class="','"><div class="','">','</div><div class="flex sm:flex-row flex-col md:gap-2 w-full"><div class="w-full max-w-full"><!--$-->',"<!--/--><!--$-->",'<!--/--></div><div class="','"><!--$-->','<!--/--><div class="relative max-w-max sm:max-w-min">',"</div></div><!--$-->","<!--/--></div></div>"],tt=["<div",' role="group" aria-label="Playlist" class="overflow-hidden rounded-xl w-full p-2 max-w-[400px] min-w-0"><div class="relative flex flex-col gap-2 min-w-full md:min-w-[20rem] w-full bg-bg2 max-h-[30rem] px-1 overflow-y-auto scrollbar"><h3 class="sticky top-0 left-0 z-10 text-lg font-bold sm:text-xl "><!--$-->',"<!--/--> - <!--$-->","<!--/--> / <!--$-->","<!--/--></h3><!--$-->","<!--/--></div></div>"];function $t(){console.log(new Date().toISOString().split("T")[1],"rendering watch page");const e=Ce(),[a]=Y(),[r,g]=p(void 0);$(()=>{e.query.v&&g(e.query.v)});const l=N(()=>({queryKey:["streams",r(),a.instance.api_url],queryFn:()=>me.fetchVideo(r(),a.instance.api_url),enabled:!!(r()&&a.instance.api_url),refetchOnReconnect:!1,refetchOnMount:!1,cacheTime:1/0,staleTime:100*60*1e3,deferStream:!0})),[u,i]=$e(),[x,h]=p(!0);$(async()=>{if(e.query.v){if(console.time("verifyDownloaded"),!("getDirectory"in navigator.storage)){h(!1);return}try{const f=await Ie(e.query.v);if(console.log("downloaded",f),f){console.log("video downloaded");const E=await He(e.query.v);console.log("manifest",E);return}else console.log("video not downloaded"),h(!1),console.timeEnd("verifyDownloaded")}catch(f){console.log(f),h(!1);return}}});const[R,S]=Se(),s=X(),w=()=>e.query.list?.startsWith("conduit-"),T=N(()=>({queryKey:["sponsors",e.query.v,a.instance.api_url],queryFn:async()=>{const f=await globalThis.crypto.subtle.digest("SHA-256",new TextEncoder().encode(e.query.v)),O=Array.from(new Uint8Array(f)).map(v=>v.toString(16).padStart(2,"0")).join("").slice(0,5),U=new URL("https://sponsor.ajay.app/api/skipSegments/"+O);U.searchParams.set("categories",JSON.stringify(["sponsor","interaction","selfpromo","music_offtopic"]));const V=U.toString();console.log(V);const b=await fetch(V);if(!b.ok){if(b.status===404)return Promise.reject("no sponsors found");{const v=await b.text();return Promise.reject("error fetching sponsors: "+v)}}const o=(await b.json()).find(v=>v.videoID===e.query.v);return o?o.segments:Promise.reject("no sponsors found")},enabled:!!(a.instance?.api_url&&!ye&&e.query.v),refetchOnReconnect:!1,retry:!1,suspense:!1,useErrorBoundary:!1})),C=N(()=>({queryKey:["playlist",e.query.list,a.instance.api_url],queryFn:async()=>{const f=await fetch(`${a.instance.api_url}/playlists/${e.query.list}`);if(f.ok)return await f.json()},enabled:!!(a.instance?.api_url&&e.query.list&&!w()),refetchOnReconnect:!1}));$(()=>{console.log(s.store,"STORE"),console.log(T.data,T.error)}),$(()=>{C.isSuccess?i(C.data):i(void 0)}),$(()=>{l.data&&(document.title=`${l.data.title} - Conduit`)});const[H,F]=p(),[y,I]=p(void 0);$(()=>{if(!e.query.list){i(void 0);return}});const[P,D]=fe();$(async()=>{if(!e.query.list){i(void 0),console.log("fetching playlist no list id");return}if(!w()||(console.log("fetching playlist"),I(e.query.list),console.log("fetching playlistlist id",y()),!y()))return;const f=s.store.playlists[y()];console.log("setting playlist",f),i(f),setTimeout(()=>{H()?.scrollTo({top:e.query.index?Number(e.query.index)*80:0,behavior:"smooth"})},100)}),$(()=>{S("player","dismissed",!1),S("player","small",!1)});const[_,M]=p(1e3);return Q(()=>{M(window.innerWidth),window.addEventListener("resize",f=>{M(window.innerWidth)}),G(()=>{window.removeEventListener("resize",f=>{M(window.innerWidth)})})}),d(et,m(),`flex ${P.fullscreen?"flex-col":""} ${P.fullscreen?"":"flex-col lg:flex-row"}`,`flex flex-col ${P.fullscreen?"":"flex-grow"} ${P.fullscreen?"w-full":""}`,c(t(L,{get when(){return P.fullscreen},get children(){return d(Ze,m())}})),c(t(be,{get downloaded(){return x()}})),c(t(L,{get when(){return(_()>600||te())&&l.data},get children(){return d(Xe,m(),c(t(de,{get videoId(){return ne(l.data)},get uploader(){return l.data.uploader},get display(){return _()>600?"default":"bottomsheet"}})))}})),"flex flex-col gap-2 items-center w-full min-w-0 max-w-max",c(t(L,{get when(){return u()},keyed:!0,children:f=>d(tt,m(),c(f.name),c(e.query.index),c(f.relatedStreams.length),c(t(q,{get each(){return f.relatedStreams},children:(E,O)=>t(Le,{get list(){return e.query.list},get index(){return O()+1},v:E,get active(){return e.query.index??1}})})))})),c(t(Te,{})),c(t(L,{get when(){return _()<=600&&!te()&&l.data},get children(){return t(de,{get videoId(){return ne(l.data)},get uploader(){return l.data.uploader},display:"default"})}})))}export{$t as default};
//# sourceMappingURL=watch.js.map
