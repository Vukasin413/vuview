import{b6 as m,aP as l,aQ as y,aR as b,aS as p,aT as f,aU as T,aV as c,aX as E,aW as k,aY as u,b0 as L,b1 as v,b2 as S,b3 as w,b4 as C,b5 as D}from"./syncStore-BssUQgBy.js";import{VideoProvider as W}from"./vidstack-video-DJmD_cO0.js";import{R as _}from"./vidstack-CpkvFYuN-DVxRo5ek.js";import"./routing-BmD2xUmi.js";import"./Link-Dg-h0Eyu.js";import"./components-BMGKah2q.js";import"./index-BnPmuIsI.js";import"./index-DPECAXpK.js";import"./index-Cb4tY8hP.js";import"./vidstack-BJhWhebu-B429KQl9.js";const $=r=>D(r);class I{constructor(t,i){this.m=t,this.b=i,this.g=null,this.nd=null,this.od={},this.pd=new Set,this.yk=-1}get instance(){return this.g}setup(t){const{streamType:i}=this.b.$state,s=b(i).includes("live"),e=b(i).includes("ll-");this.g=new t({lowLatencyMode:e,backBufferLength:e?4:s?8:void 0,renderTextTracksNatively:!1,...this.od});const o=this.Sg.bind(this);for(const n of Object.values(t.Events))this.g.on(n,o);this.g.on(t.Events.ERROR,this.U.bind(this));for(const n of this.pd)n(this.g);this.b.player.dispatch("hls-instance",{detail:this.g}),this.g.attachMedia(this.m),this.g.on(t.Events.FRAG_LOADING,this.Bk.bind(this)),this.g.on(t.Events.AUDIO_TRACK_SWITCHED,this.Tg.bind(this)),this.g.on(t.Events.LEVEL_SWITCHED,this.Ug.bind(this)),this.g.on(t.Events.LEVEL_LOADED,this.Vg.bind(this)),this.g.on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,this.Wg.bind(this)),this.g.on(t.Events.CUES_PARSED,this.Xg.bind(this)),this.b.qualities[p.Za]=this.Yg.bind(this),f(this.b.qualities,"change",this.Yo.bind(this)),f(this.b.audioTracks,"change",this.Zo.bind(this)),this.nd=T(this._g.bind(this))}Wo(t,i){return new c($(t),{detail:i})}_g(){if(!this.b.$state.live())return;const t=new _(this.$g.bind(this));return t.Bb(),t.ra.bind(t)}$g(){this.b.$state.liveSyncPosition.set(this.g?.liveSyncPosition??1/0)}Sg(t,i){this.b.player?.dispatch(this.Wo(t,i))}Wg(t,i){const s=this.Wo(t,i);let e=-1;for(let o=0;o<i.tracks.length;o++){const n=i.tracks[o],h=n.subtitleTrack??n.closedCaptions,d=new E({id:`hls-${n.kind}-${o}`,src:h?.url,label:n.label,language:h?.lang,kind:n.kind,default:n.default});d[k.M]=2,d[k.Ua]=()=>{d.mode==="showing"?(this.g.subtitleTrack=o,e=o):e===o&&(this.g.subtitleTrack=-1,e=-1)},this.b.textTracks.add(d,s)}}Xg(t,i){const s=this.g?.subtitleTrack,e=this.b.textTracks.getById(`hls-${i.type}-${s}`);if(!e)return;const o=this.Wo(t,i);for(const n of i.cues)n.positionAlign="auto",e.addCue(n,o)}Tg(t,i){const s=this.b.audioTracks[i.id];if(s){const e=this.Wo(t,i);this.b.audioTracks[u.pa](s,!0,e)}}Ug(t,i){const s=this.b.qualities[i.level];if(s){const e=this.Wo(t,i);this.b.qualities[u.pa](s,!0,e)}}Vg(t,i){if(this.b.$state.canPlay())return;const{type:s,live:e,totalduration:o,targetduration:n}=i.details,h=this.Wo(t,i);this.b.delegate.c("stream-type-change",e?s==="EVENT"&&Number.isFinite(o)&&n>=10?"live:dvr":"live":"on-demand",h),this.b.delegate.c("duration-change",o,h);const d=this.g.media;this.g.currentLevel===-1&&this.b.qualities[p.Ya](!0,h);for(const a of this.g.audioTracks){const g={id:a.id.toString(),label:a.name,language:a.lang||"",kind:"main"};this.b.audioTracks[u.oa](g,h)}for(const a of this.g.levels){const g={id:a.id?.toString()??a.height+"p",width:a.width,height:a.height,codec:a.codecSet,bitrate:a.bitrate};this.b.qualities[u.oa](g,h)}d.dispatchEvent(new c("canplay",{trigger:h}))}U(t,i){if(i.fatal)switch(i.type){case"networkError":this.Ck(i.error);break;case"mediaError":this.g?.recoverMediaError();break;default:this.Ak(i.error);break}}Bk(){this.yk>=0&&this.zk()}Ck(t){this.zk(),this.g?.startLoad(),this.yk=window.setTimeout(()=>{this.yk=-1,this.Ak(t)},5e3)}zk(){clearTimeout(this.yk),this.yk=-1}Ak(t){this.b.delegate.c("error",{message:t.message,code:1,error:t})}Yg(){this.g&&(this.g.currentLevel=-1)}Yo(){const{qualities:t}=this.b;!this.g||t.auto||(this.g[t.switch+"Level"]=t.selectedIndex,L&&(this.m.currentTime=this.m.currentTime))}Zo(){const{audioTracks:t}=this.b;this.g&&this.g.audioTrack!==t.selectedIndex&&(this.g.audioTrack=t.selectedIndex)}Dk(t){this.zk(),l(t.src)&&this.g?.loadSource(t.src)}ah(){this.zk(),this.g?.destroy(),this.g=null,this.nd?.(),this.nd=null}}class R{constructor(t,i,s){this.W=t,this.b=i,this.Ca=s,this.bh()}async bh(){const t={onLoadStart:this.Ea.bind(this),onLoaded:this.qd.bind(this),onLoadError:this.ch.bind(this)};let i=await H(this.W,t);if(v(i)&&!l(this.W)&&(i=await A(this.W,t)),!i)return null;if(!i.isSupported()){const s="[vidstack] `hls.js` is not supported in this environment";return this.b.player.dispatch(new c("hls-unsupported")),this.b.delegate.c("error",{message:s,code:4}),null}return i}Ea(){this.b.player.dispatch(new c("hls-lib-load-start"))}qd(t){this.b.player.dispatch(new c("hls-lib-loaded",{detail:t})),this.Ca(t)}ch(t){const i=S(t);this.b.player.dispatch(new c("hls-lib-load-error",{detail:i})),this.b.delegate.c("error",{message:i.message,code:4,error:i})}}async function A(r,t={}){if(!v(r)){if(t.onLoadStart?.(),r.prototype&&r.prototype!==Function)return t.onLoaded?.(r),r;try{const i=(await r())?.default;if(i&&i.isSupported)t.onLoaded?.(i);else throw Error("");return i}catch(i){t.onLoadError?.(i)}}}async function H(r,t={}){if(l(r)){t.onLoadStart?.();try{if(await w(r),!C(window.Hls))throw Error("");const i=window.Hls;return t.onLoaded?.(i),i}catch(i){t.onLoadError?.(i)}}}const x="https://cdn.jsdelivr.net";class Y extends W{constructor(){super(...arguments),this.$$PROVIDER_TYPE="HLS",this.Xe=null,this.d=new I(this.video,this.b),this.Gb=`${x}/npm/hls.js@^1.5.0/dist/hls.min.js`}get ctor(){return this.Xe}get instance(){return this.d.instance}static{this.supported=m()}get type(){return"hls"}get canLiveSync(){return!0}get config(){return this.d.od}set config(t){this.d.od=t}get library(){return this.Gb}set library(t){this.Gb=t}preconnect(){l(this.Gb)&&y(this.Gb)}setup(){super.setup(),new R(this.Gb,this.b,t=>{this.Xe=t,this.d.setup(t),this.b.delegate.c("provider-setup",this);const i=b(this.b.$state.source);i&&this.loadSource(i)})}async loadSource(t,i){if(!l(t.src)){this.Bn();return}this.a.preload=i||"",this.yn(t,"application/x-mpegurl"),this.d.Dk(t),this.V=t}onInstance(t){const i=this.d.instance;return i&&t(i),this.d.pd.add(t),()=>this.d.pd.delete(t)}destroy(){this.d.ah()}}export{Y as HLSProvider};
//# sourceMappingURL=vidstack-hls-BPxS2LG7.js.map
