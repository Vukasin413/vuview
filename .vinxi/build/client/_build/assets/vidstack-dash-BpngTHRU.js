import{aO as S,aP as p,aQ as v,aR as w,aS as y,aT as T,aU as E,aV as u,aW as b,aX as A,aY as l,aZ as D,a_ as _,a$ as x,b0 as R,b1 as k,b2 as L,b3 as M,b4 as $,b5 as q}from"./syncStore-BssUQgBy.js";import{VideoProvider as C}from"./vidstack-video-DJmD_cO0.js";import{R as F}from"./vidstack-CpkvFYuN-DVxRo5ek.js";import"./routing-BmD2xUmi.js";import"./Link-Dg-h0Eyu.js";import"./components-BMGKah2q.js";import"./index-BnPmuIsI.js";import"./index-DPECAXpK.js";import"./index-Cb4tY8hP.js";import"./vidstack-BJhWhebu-B429KQl9.js";const I=o=>`dash-${q(o)}`;class H{constructor(t,i){this.m=t,this.b=i,this.g=null,this.nd=null,this.od={},this.pd=new Set,this.Xo=null,this._o={},this.yk=-1}get instance(){return this.g}setup(t){this.g=t().create();const i=this.So.bind(this);for(const e of Object.values(t.events))this.g.on(e,i);this.g.on(t.events.ERROR,this.U.bind(this));for(const e of this.pd)e(this.g);this.b.player.dispatch("dash-instance",{detail:this.g}),this.g.initialize(this.m,void 0,!1),this.g.updateSettings({streaming:{text:{defaultEnabled:!1,dispatchForManualRendering:!0},buffer:{fastSwitchEnabled:!0}},...this.od}),this.g.on(t.events.FRAGMENT_LOADING_STARTED,this.bp.bind(this)),this.g.on(t.events.FRAGMENT_LOADING_COMPLETED,this.cp.bind(this)),this.g.on(t.events.MANIFEST_LOADED,this.Uo.bind(this)),this.g.on(t.events.QUALITY_CHANGE_RENDERED,this.fb.bind(this)),this.g.on(t.events.TEXT_TRACKS_ADDED,this.dp.bind(this)),this.g.on(t.events.TRACK_CHANGE_RENDERED,this._d.bind(this)),this.b.qualities[y.Za]=this.Yg.bind(this),T(this.b.qualities,"change",this.Yo.bind(this)),T(this.b.audioTracks,"change",this.Zo.bind(this)),this.nd=E(this._g.bind(this))}Wo(t){return new u(I(t.type),{detail:t})}_g(){if(!this.b.$state.live())return;const t=new F(this.$g.bind(this));return t.Bb(),t.ra.bind(t)}$g(){if(!this.g)return;const t=this.g.duration()-this.g.time();this.b.$state.liveSyncPosition.set(isNaN(t)?1/0:t)}So(t){this.b.player?.dispatch(this.Wo(t))}ep(t){const i=this.Xo?.[b.T],e=(i?.track).cues;if(!i||!e)return;const n=this.Xo.id,a=this._o[n]??0,r=this.Wo(t);for(let c=a;c<e.length;c++){const h=e[c];h.positionAlign||(h.positionAlign="auto"),this.Xo.addCue(h,r)}this._o[n]=e.length}dp(t){if(!this.g)return;const i=t.tracks,e=[...this.m.textTracks].filter(a=>"manualMode"in a),n=this.Wo(t);for(let a=0;a<e.length;a++){const r=i[a],c=e[a],h=`dash-${r.kind}-${a}`,d=new A({id:h,label:r?.label??r.labels.find(f=>f.text)?.text??r?.lang??void 0,language:r.lang??void 0,kind:r.kind,default:r.defaultTrack});d[b.T]={managed:!0,track:c},d[b.M]=2,d[b.Ua]=()=>{this.g&&(d.mode==="showing"?(this.g.setTextTrack(a),this.Xo=d):(this.g.setTextTrack(-1),this.Xo=null))},this.b.textTracks.add(d,n)}}_d(t){const{mediaType:i,newMediaInfo:e}=t;if(i==="audio"){const n=this.b.audioTracks.getById(`dash-audio-${e.index}`);if(n){const a=this.Wo(t);this.b.audioTracks[l.pa](n,!0,a)}}}fb(t){if(t.mediaType!=="video")return;const i=this.b.qualities[t.newQuality];if(i){const e=this.Wo(t);this.b.qualities[l.pa](i,!0,e)}}Uo(t){if(this.b.$state.canPlay()||!this.g)return;const{type:i,mediaPresentationDuration:e}=t.data,n=this.Wo(t);this.b.delegate.c("stream-type-change",i!=="static"?"live":"on-demand",n),this.b.delegate.c("duration-change",e,n),this.b.qualities[y.Ya](!0,n);const a=this.g.getVideoElement(),r=this.g.getTracksForTypeFromManifest("video",t.data),c=[...new Set(r.map(s=>s.mimeType))].find(s=>s&&D(a,s)),h=r.filter(s=>c===s.mimeType)[0];let d=this.g.getTracksForTypeFromManifest("audio",t.data);const f=[...new Set(d.map(s=>s.mimeType))].find(s=>s&&_(a,s));if(d=d.filter(s=>f===s.mimeType),h.bitrateList.forEach((s,g)=>{const m={id:s.id?.toString()??`dash-bitrate-${g}`,width:s.width??0,height:s.height??0,bitrate:s.bandwidth??0,codec:h.codec,index:g};this.b.qualities[l.oa](m,n)}),x(h.index)){const s=this.b.qualities[h.index];s&&this.b.qualities[l.pa](s,!0,n)}d.forEach((s,g)=>{const m={id:`dash-audio-${s?.index}`,label:s.label??s.lang??"",language:s.lang??"",kind:"main",mimeType:s.mimeType,codec:s.codec,index:g};this.b.audioTracks[l.oa](m,n)}),a.dispatchEvent(new u("canplay",{trigger:n}))}U(t){const{type:i,error:e}=t;switch(e.code){case 27:this.Ck(e);break;default:this.Ak(e);break}}bp(){this.yk>=0&&this.zk()}cp(t){t.mediaType==="text"&&requestAnimationFrame(this.ep.bind(this,t))}Ck(t){this.zk(),this.g?.play(),this.yk=window.setTimeout(()=>{this.yk=-1,this.Ak(t)},5e3)}zk(){clearTimeout(this.yk),this.yk=-1}Ak(t){this.b.delegate.c("error",{message:t.message??"",code:1,error:t})}Yg(){this.Ro("video",!0);const{qualities:t}=this.b;this.g?.setQualityFor("video",t.selectedIndex,!0)}Ro(t,i){this.g?.updateSettings({streaming:{abr:{autoSwitchBitrate:{[t]:i}}}})}Yo(){const{qualities:t}=this.b;!this.g||t.auto||!t.selected||(this.Ro("video",!1),this.g.setQualityFor("video",t.selectedIndex,t.switch==="current"),R&&(this.m.currentTime=this.m.currentTime))}Zo(){if(!this.g)return;const{audioTracks:t}=this.b,i=this.g.getTracksFor("audio").find(e=>t.selected&&t.selected.id===`dash-audio-${e.index}`);i&&this.g.setCurrentTrack(i)}H(){this.zk(),this.Xo=null,this._o={}}loadSource(t){this.H(),p(t.src)&&this.g?.attachSource(t.src)}destroy(){this.H(),this.g?.destroy(),this.g=null,this.nd?.(),this.nd=null}}class N{constructor(t,i,e){this.W=t,this.b=i,this.Ca=e,this.bh()}async bh(){const t={onLoadStart:this.Ea.bind(this),onLoaded:this.qd.bind(this),onLoadError:this.ch.bind(this)};let i=await G(this.W,t);if(k(i)&&!p(this.W)&&(i=await P(this.W,t)),!i)return null;if(!window.dashjs.supportsMediaSource()){const e="[vidstack] `dash.js` is not supported in this environment";return this.b.player.dispatch(new u("dash-unsupported")),this.b.delegate.c("error",{message:e,code:4}),null}return i}Ea(){this.b.player.dispatch(new u("dash-lib-load-start"))}qd(t){this.b.player.dispatch(new u("dash-lib-loaded",{detail:t})),this.Ca(t)}ch(t){const i=L(t);this.b.player.dispatch(new u("dash-lib-load-error",{detail:i})),this.b.delegate.c("error",{message:i.message,code:4,error:i})}}async function P(o,t={}){if(!k(o)){if(t.onLoadStart?.(),o.prototype&&o.prototype!==Function)return t.onLoaded?.(o),o;try{const i=(await o())?.default;if(i)t.onLoaded?.(i);else throw Error("");return i}catch(i){t.onLoadError?.(i)}}}async function G(o,t={}){if(p(o)){t.onLoadStart?.();try{if(await M(o),!$(window.dashjs.MediaPlayer))throw Error("");const i=window.dashjs.MediaPlayer;return t.onLoaded?.(i),i}catch(i){t.onLoadError?.(i)}}}const W="https://cdn.jsdelivr.net";class K extends C{constructor(){super(...arguments),this.$$PROVIDER_TYPE="DASH",this.Xe=null,this.d=new H(this.video,this.b),this.Gb=`${W}/npm/dashjs@4.7.4/dist/dash.all.min.js`}get ctor(){return this.Xe}get instance(){return this.d.instance}static{this.supported=S()}get type(){return"dash"}get canLiveSync(){return!0}get config(){return this.d.od}set config(t){this.d.od=t}get library(){return this.Gb}set library(t){this.Gb=t}preconnect(){p(this.Gb)&&v(this.Gb)}setup(){super.setup(),new N(this.Gb,this.b,t=>{this.Xe=t,this.d.setup(t),this.b.delegate.c("provider-setup",this);const i=w(this.b.$state.source);i&&this.loadSource(i)})}async loadSource(t,i){if(!p(t.src)){this.Bn();return}this.a.preload=i||"",this.yn(t,"application/x-mpegurl"),this.d.loadSource(t),this.V=t}onInstance(t){const i=this.d.instance;return i&&t(i),this.d.pd.add(t),()=>this.d.pd.delete(t)}destroy(){this.d.destroy()}}export{K as DASHProvider};
//# sourceMappingURL=vidstack-dash-BpngTHRU.js.map
