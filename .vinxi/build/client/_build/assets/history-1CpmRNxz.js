import{l as Ye,j as q,e as F,r as Ce,w as Q,S as Fe,L as ze,M as et,O as tt,x as lt,y as Oe,F as qe,a4 as We,A as ve,K as oe,G as nt}from"./routing-BmD2xUmi.js";import{L as Ge,Q as Qe,at as Ve,R as rt,O as Ee,a4 as it,aH as st}from"./syncStore-BssUQgBy.js";import{u as ot}from"./useIntersectionObserver-DOCe7fLW.js";import{F as He}from"./Field-BXIxlrTp.js";import{T as at}from"./index-DyZHI5kj.js";import"./Link-Dg-h0Eyu.js";import"./components-BMGKah2q.js";import"./index-BnPmuIsI.js";import"./index-DPECAXpK.js";import"./index-Cb4tY8hP.js";var ct=Oe("<strong>"),ut=Oe('<form><br><div><input type=file></div><textarea class=text-black></textarea><br><div></div> <div><progress></progress><div></div></div><div><button class="btn w-auto">Import');function ft(t){const[i,n]=q([]),[r,a]=q(0),[g,C]=q(0),[z,le]=q(0),[ne,re]=q(0);let A;const E=()=>i()?.length||0;function he(){if(!A?.files?.[0])return;A.files[0].text().then(_=>{if(console.log(_),n([]),_.includes("conduit")){const w=JSON.parse(_);console.log(w);const s=w.history;console.log(s),n(s)}else if(_.includes("products")&&_.includes("YouTube")){const w=JSON.parse(_);console.log(w);const s=w.map(e=>{const N={url:e.titleUrl.split("https://www.youtube.com")[1],title:e.title,uploaderName:e.subtitles[0].name,uploaderUrl:e.subtitles[0].url.split("https://www.youtube.com")[1],watchedAt:new Date(e.time).getTime()};return console.log(N),N});console.log(s),n(s.sort((e,N)=>N.watchedAt-e.watchedAt))}else if(_.includes("watchPositions")){console.log("LibreTube");const w=JSON.parse(_),s=w.watchHistory.map(e=>({url:`/watch?v=${e.videoId}`,duration:e.duration,thumbnail:e.thumbnailUrl,title:e.title,uploaderName:e.uploader,uploaderUrl:e.uploaderUrl,uploaded:new Date(e.uploadDate).getTime(),currentTime:w.watchPositions.find(N=>N.videoId===e.videoId)?.position/1e3}));n(s.sort((e,N)=>N.watchedAt-e.watchedAt))}else if(_.includes("watchHistory")){const w=JSON.parse(_);console.log(w);const s=w.watchHistory.map(e=>({duration:e.duration,url:e.url,title:e.title,uploaderName:e.uploaderName,uploaderUrl:e.uploaderUrl,watchedAt:e.watchedAt??0,currentTime:e.currentTime??0}));n(s.sort((e,N)=>N.watchedAt-e.watchedAt))}else if(_.startsWith('{"videoId:')){_=`[${_.replace(/\n/g,", ").slice(0,-2)}]`;let w=JSON.parse(_);console.log(w);const s=w.map(e=>({duration:e.duration,thumbnail:e.thumbnail,title:e.title,uploaderName:e.author,uploaderUrl:e.authorUrl,videoId:e.videoId,watchedAt:e.watchedDate,currentTime:e.currentTime})).sort((e,N)=>N.watchedAt-e.watchedAt);n(s)}else if(_.startsWith('{"subscriptions":')){const w=JSON.parse(_);console.log(w);const s=w.watch_history.map(e=>({videoId:e,watchedAt:0,currentTime:0}));n(s)}else alert("Unsupported file");console.log(i())})}const Y=Ge();async function ge(D){D.preventDefault(),D.stopPropagation();const _=[];if(!Y.store)return;for(const s of i()){const e=Ve(s);if(!e){le(z()+1),a(r()+1);continue}if(Y.store.history[e]){a(r()+1),re(ne()+1);continue}_.push({[e]:s}),a(r()+1),C(g()+1)}_.sort((s,e)=>s[Object.keys(s)[0]].watchedAt?!e[Object.keys(e)[0]].watchedAt||s[Object.keys(s)[0]].watchedAt>e[Object.keys(e)[0]].watchedAt?-1:s[Object.keys(s)[0]].watchedAt<e[Object.keys(e)[0]].watchedAt?1:0:1);const w=async()=>new Promise(s=>{We(()=>{_.forEach(e=>{Y.setStore("history",e)})}),s("done")});rt.promise(w,{loading:"Importing history",success:s=>s,error:()=>"Error importing history"}),await w()}return F(Qe,{title:"Import History",get isOpen(){return t.isOpen},get setIsOpen(){return t.setIsOpen},get children(){var D=Ce(ut),_=D.firstChild,w=_.nextSibling,s=w.firstChild,e=w.nextSibling,N=e.nextSibling,de=N.nextSibling,x=de.nextSibling,V=x.nextSibling,U=V.firstChild,P=U.nextSibling,M=V.nextSibling,X=M.firstChild;s.$$input=he;var K=A;return typeof K=="function"?qe(K,s):A=s,e.$$input=ee=>{console.log(ee.currentTarget.value),n(JSON.parse(ee.currentTarget.value).history),console.log(i())},Q(de,F(Fe,{get when(){return E()>0},get children(){var ee=Ce(ct);return Q(ee,()=>`Found ${E()} items`),ee}})),Q(P,()=>`Success: ${g()} Error: ${z()} Skipped: ${ne()}`),X.$$click=ge,ze(()=>et(U,"max",E())),ze(()=>tt(U,"value",r())),lt(),D}})}Ye(["input","click"]);const ht=new Intl.Collator("en").compare,Ne=1/0,Pe=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Be="eexxaacctt",pt="A-Z",gt="a-z",Te=(t,i,n)=>t.replace(pt,i).replace(gt,n),Je={unicode:!1,alpha:null,interSplit:"[^A-Za-z\\d']+",intraSplit:"[a-z][A-Z]",intraBound:"[A-Za-z]\\d|\\d[A-Za-z]|[a-z][A-Z]",interLft:0,interRgt:0,interChars:".",interIns:Ne,intraChars:"[a-z\\d']",intraIns:0,intraContr:"'[a-z]{1,2}\\b",intraMode:0,intraSlice:[1,Ne],intraSub:0,intraTrn:0,intraDel:0,intraFilt:(t,i,n)=>!0,sort:(t,i,n)=>{let{idx:r,chars:a,terms:g,interLft2:C,interLft1:z,start:le,intraIns:ne,interIns:re}=t;return r.map((A,E)=>E).sort((A,E)=>a[E]-a[A]||ne[A]-ne[E]||g[E]+C[E]+.5*z[E]-(g[A]+C[A]+.5*z[A])||re[A]-re[E]||le[A]-le[E]||ht(i[r[A]],i[r[E]]))}},De=(t,i)=>i==0?"":i==1?t+"??":i==Ne?t+"*?":t+`{0,${i}}?`,Ze="(?:\\b|_)";function Le(t){t=Object.assign({},Je,t);let{unicode:i,interLft:n,interRgt:r,intraMode:a,intraSlice:g,intraIns:C,intraSub:z,intraTrn:le,intraDel:ne,intraContr:re,intraSplit:A,interSplit:E,intraBound:he,intraChars:Y}=t,ge=t.letters??t.alpha;if(ge!=null){let l=ge.toLocaleUpperCase(),u=ge.toLocaleLowerCase();E=Te(E,l,u),A=Te(A,l,u),he=Te(he,l,u),Y=Te(Y,l,u),re=Te(re,l,u)}let D=i?"u":"";const _=new RegExp('".+?"',"gi"+D),w=new RegExp(`(?:\\s+|^)-${Y}+`,"gi"+D);let{intraRules:s}=t;s==null&&(s=l=>{let u=Je.intraSlice,O=0,p=0,S=0,f=0,b=l.length;return b<=4?b>=3&&(S=Math.min(le,1),b==4&&(O=Math.min(C,1))):(u=g,O=C,p=z,S=le,f=ne),{intraSlice:u,intraIns:O,intraSub:p,intraTrn:S,intraDel:f}});let e=!!A,N=new RegExp(A,"g"+D),de=new RegExp(E,"g"+D),x=new RegExp("^"+E+"|"+E+"$","g"+D),V=new RegExp(re,"gi"+D);const U=l=>{let u=[];l=l.replace(_,p=>(u.push(p),Be)),l=l.replace(x,"").toLocaleLowerCase(),e&&(l=l.replace(N,p=>p[0]+" "+p[1]));let O=0;return l.split(de).filter(p=>p!="").map(p=>p===Be?u[O++]:p)},P=(l,u=0,O=!1)=>{let p=U(l);if(p.length==0)return[];let S=Array(p.length).fill("");p=p.map((d,m)=>d.replace(V,J=>(S[m]=J,"")));let f;if(a==1)f=p.map((d,m)=>{let{intraSlice:J,intraIns:o,intraSub:h,intraTrn:c,intraDel:L}=s(d);if(o+h+c+L==0)return d+S[m];if(d[0]==='"')return Pe(d.slice(1,-1));let[y,T]=J,$=d.slice(0,y),H=d.slice(T),R=d.slice(y,T);o==1&&$.length==1&&$!=R[0]&&($+="(?!"+$+")");let ae=R.length,ie=[d];if(h)for(let I=0;I<ae;I++)ie.push($+R.slice(0,I)+Y+R.slice(I+1)+H);if(c)for(let I=0;I<ae-1;I++)R[I]!=R[I+1]&&ie.push($+R.slice(0,I)+R[I+1]+R[I]+R.slice(I+2)+H);if(L)for(let I=0;I<ae;I++)ie.push($+R.slice(0,I+1)+"?"+R.slice(I+1)+H);if(o){let I=De(Y,1);for(let ce=0;ce<ae;ce++)ie.push($+R.slice(0,ce)+I+R.slice(ce)+H)}return"(?:"+ie.join("|")+")"+S[m]});else{let d=De(Y,C);u==2&&C>0&&(d=")("+d+")("),f=p.map((m,J)=>m[0]==='"'?Pe(m.slice(1,-1)):m.split("").map((o,h,c)=>(C==1&&h==0&&c.length>1&&o!=c[h+1]&&(o+="(?!"+o+")"),o)).join(d)+S[J])}let b=n==2?Ze:"",B=r==2?Ze:"",te=B+De(t.interChars,t.interIns)+b;return u>0?O?f=b+"("+f.join(")"+B+"|"+b+"(")+")"+B:(f="("+f.join(")("+te+")(")+")",f="(.??"+b+")"+f+"("+B+".*)"):(f=f.join(te),f=b+f+B),[new RegExp(f,"i"+D),p,S]},M=(l,u,O)=>{let[p]=P(u);if(p==null)return null;let S=[];if(O!=null)for(let f=0;f<O.length;f++){let b=O[f];p.test(l[b])&&S.push(b)}else for(let f=0;f<l.length;f++)p.test(l[f])&&S.push(f);return S};let X=!!he,K=new RegExp(E,D),ee=new RegExp(he,D);const _e=(l,u,O)=>{let[p,S,f]=P(O,1),[b]=P(O,2),B=S.length,te=l.length,d=Array(te).fill(0),m={idx:Array(te),start:d.slice(),chars:d.slice(),terms:d.slice(),interIns:d.slice(),intraIns:d.slice(),interLft2:d.slice(),interRgt2:d.slice(),interLft1:d.slice(),interRgt1:d.slice(),ranges:Array(te)},J=n==1||r==1,o=0;for(let h=0;h<l.length;h++){let c=u[l[h]],L=c.match(p),y=L.index+L[1].length,T=y,$=!1,H=0,R=0,ae=0,ie=0,ye=0,I=0,ce=0,ke=0,me=[];for(let j=0,k=2;j<B;j++,k+=2){let pe=L[k].toLocaleLowerCase(),se=S[j],ue=se[0]=='"'?se.slice(1,-1):se+f[j],W=ue.length,G=pe.length,Z=pe==ue;if(!Z&&L[k+1].length>=W){let v=L[k+1].toLocaleLowerCase().indexOf(ue);v>-1&&(me.push(T,G,v,W),T+=xe(L,k,v,W),pe=ue,G=W,Z=!0,j==0&&(y=T))}if(J||Z){let v=T-1,fe=T+G,$e=!1,Ie=!1;if(v==-1||K.test(c[v]))Z&&H++,$e=!0;else{if(n==2){$=!0;break}if(X&&ee.test(c[v]+c[v+1]))Z&&R++,$e=!0;else if(n==1){let Ae=L[k+1],Se=T+G;if(Ae.length>=W){let we=0,be=!1,Ke=new RegExp(ue,"ig"+D),Me;for(;Me=Ke.exec(Ae);){we=Me.index;let Ue=Se+we,je=Ue-1;if(je==-1||K.test(c[je])){H++,be=!0;break}else if(ee.test(c[je]+c[Ue])){R++,be=!0;break}}be&&($e=!0,me.push(T,G,we,W),T+=xe(L,k,we,W),pe=ue,G=W,Z=!0,j==0&&(y=T))}if(!$e){$=!0;break}}}if(fe==c.length||K.test(c[fe]))Z&&ae++,Ie=!0;else{if(r==2){$=!0;break}if(X&&ee.test(c[fe-1]+c[fe]))Z&&ie++,Ie=!0;else if(r==1){$=!0;break}}Z&&(ye+=W,$e&&Ie&&I++)}if(G>W&&(ke+=G-W),j>0&&(ce+=L[k-1].length),!t.intraFilt(ue,pe,T)){$=!0;break}j<B-1&&(T+=G+L[k+1].length)}if(!$){m.idx[o]=l[h],m.interLft2[o]=H,m.interLft1[o]=R,m.interRgt2[o]=ae,m.interRgt1[o]=ie,m.chars[o]=ye,m.terms[o]=I,m.interIns[o]=ce,m.intraIns[o]=ke,m.start[o]=y;let j=c.match(b),k=j.index+j[1].length,pe=me.length,se=pe>0?0:1/0,ue=pe-4;for(let v=2;v<j.length;){let fe=j[v].length;if(se<=ue&&me[se]==k){let $e=me[se+1],Ie=me[se+2],Ae=me[se+3],Se=v,we="";for(let be=0;be<$e;Se++)we+=j[Se],be+=j[Se].length;j.splice(v,Se-v,we),k+=xe(j,v,Ie,Ae),se+=4}else k+=fe,v++}k=j.index+j[1].length;let W=m.ranges[o]=[],G=k,Z=k;for(let v=2;v<j.length;v++){let fe=j[v].length;k+=fe,v%2==0?Z=k:fe>0&&(W.push(G,Z),G=Z=k)}Z>G&&W.push(G,Z),o++}}if(o<l.length)for(let h in m)m[h]=m[h].slice(0,o);return m},xe=(l,u,O,p)=>{let S=l[u]+l[u+1].slice(0,O);return l[u-1]+=S,l[u]=l[u+1].slice(O,O+p),l[u+1]=l[u+1].slice(O+p),S.length},Re=(l,u,O=!1,p=1e3,S)=>{let f=null,b=null,B=[];u=u.replace(w,h=>(B.push(h.trim().slice(1)),""));let te=U(u),d;if(B.length>0){if(d=new RegExp(B.join("|"),"i"+D),te.length==0){let h=[];for(let c=0;c<l.length;c++)d.test(l[c])||h.push(c);return[h,null,null]}}else if(te.length==0)return[null,null,null];if(O){let h=U(u);if(h.length>1){let c=h.slice().sort((y,T)=>T.length-y.length);for(let y=0;y<c.length;y++){if(S?.length==0)return[[],null,null];S=M(l,c[y],S)}f=Xe(h).map(y=>y.join(" ")),b=[];let L=new Set;for(let y=0;y<f.length;y++)if(L.size<S.length){let T=S.filter(H=>!L.has(H)),$=M(l,f[y],T);for(let H=0;H<$.length;H++)L.add($[H]);b.push($)}else b.push([])}}f==null&&(f=[u],b=[S?.length>0?S:M(l,u)]);let m=null,J=null;if(B.length>0&&(b=b.map(h=>h.filter(c=>!d.test(l[c])))),b.reduce((h,c)=>h+c.length,0)<=p){m={},J=[];for(let h=0;h<b.length;h++){let c=b[h];if(c==null||c.length==0)continue;let L=f[h],y=_e(c,l,L),T=t.sort(y,l,L);if(h>0)for(let $=0;$<T.length;$++)T[$]+=J.length;for(let $ in y)m[$]=(m[$]??[]).concat(y[$]);J=J.concat(T)}}return[[].concat(...b),m,J]};return{search:(...l)=>Re(...l),split:U,filter:M,info:_e,sort:t.sort}}const dt=(()=>{let t={A:"ÁÀÃÂÄĄ",a:"áàãâäą",E:"ÉÈÊËĖ",e:"éèêëę",I:"ÍÌÎÏĮ",i:"íìîïį",O:"ÓÒÔÕÖ",o:"óòôõö",U:"ÚÙÛÜŪŲ",u:"úùûüūų",C:"ÇČ",c:"çč",N:"Ñ",n:"ñ",S:"Š",s:"š"},i=new Map,n="";for(let g in t)t[g].split("").forEach(C=>{n+=C,i.set(C,g)});let r=new RegExp(`[${n}]`,"g"),a=g=>i.get(g);return g=>{if(typeof g=="string")return g.replace(r,a);let C=Array(g.length);for(let z=0;z<g.length;z++)C[z]=g[z].replace(r,a);return C}})();function Xe(t){t=t.slice();let i=t.length,n=[t.slice()],r=new Array(i).fill(0),a=1,g,C;for(;a<i;)r[a]<a?(g=a%2&&r[a],C=t[a],t[a]=t[g],t[g]=C,++r[a],a=1,n.push(t.slice())):(r[a]=0,++a);return n}const mt=(t,i)=>i?`<mark>${t}</mark>`:t,$t=(t,i)=>t+i;function wt(t,i,n=mt,r="",a=$t){r=a(r,n(t.substring(0,i[0]),!1))??r;for(let g=0;g<i.length;g+=2){let C=i[g],z=i[g+1];r=a(r,n(t.substring(C,z),!0))??r,g<i.length-3&&(r=a(r,n(t.substring(i[g+1],i[g+2]),!1))??r)}return r=a(r,n(t.substring(i[i.length-1]),!1))??r,r}Le.latinize=dt;Le.permute=t=>Xe([...Array(t.length).keys()]).sort((n,r)=>{for(let a=0;a<n.length;a++)if(n[a]!=r[a])return n[a]-r[a];return 0}).map(n=>n.map(r=>t[r]));Le.highlight=wt;var St=Oe('<div class="flex flex-col items-center justify-center"><div class="text-sm text-text1">This operation cannot be undone.</div><div class="flex mt-4 flex-col gap-2 items-center"><!$><!/><div class="flex gap-2"><!$><!/><!$><!/>'),bt=Oe('<div class="w-full h-20 mt-2">'),_t=Oe('<div class=""><!$><!/><!$><!/><!$><!/><!$><!/><!$><!/><!$><!/><!$><!/><div class="flex flex-wrap justify-center h-full min-h-[80vh]">');function jt(){const[t,i]=q(50);q([]);const n=Ge();function r(){We(()=>{Object.keys(n.store.history).forEach(x=>{n.setStore("history",x,void 0)})})}ve(()=>{n.store.history&&console.log(Object.keys(n.store.history)?.length)});const[a,g]=q(void 0),C=ot({setTarget:()=>a()});ve(()=>{C()&&i(x=>x+10)});const z=(x,V)=>{const U=X=>new Date(X).getTime();if(!x.watchedAt)return 1;if(!V.watchedAt)return-1;const P=U(x.watchedAt),M=U(V.watchedAt);return isNaN(P)?1:isNaN(M)?-1:P<=0?1:M<=0?-1:M-P},[le,ne]=q([]),[re,A]=q(!1),[E,he]=q(""),Y=st(x=>{he(x)},500),ge=new Le({intraMode:1,intraChars:"[w-]",intraSub:1,intraTrn:1,intraDel:1,intraIns:1});ve(()=>{if(E()){const x=Object.values(n.store.history).map(K=>`${K.title} ${K.uploaderName}`),[V,U,P]=ge.search(x,E(),!1),M=Object.values(n.store.history),X=V?.map(K=>M[K])?.slice(0,t())??[];ne(X)}else{if(!n.store.history)return;ne(Object.values(n.store.history).sort(z).slice(0,t()))}});const D=()=>{const x=Object.values(n.store.history),V=JSON.stringify({platform:"Conduit",version:1,history:x},null,2),U=new Blob([V],{type:"application/json"}),P=URL.createObjectURL(U),M=document.createElement("a");M.href=P;const X=`conduit-history-${new Date().toISOString()}.json`;M.download=X,M.click(),URL.revokeObjectURL(P)},[_,w]=q(!1),[s,e]=q(""),[N,de]=q(!1);return q(!1),(()=>{var x=Ce(_t),V=x.firstChild,[U,P]=oe(V.nextSibling),M=U.nextSibling,[X,K]=oe(M.nextSibling),ee=X.nextSibling,[_e,xe]=oe(ee.nextSibling),Re=_e.nextSibling,[l,u]=oe(Re.nextSibling),O=l.nextSibling,[p,S]=oe(O.nextSibling),f=p.nextSibling,[b,B]=oe(f.nextSibling),te=b.nextSibling,[d,m]=oe(te.nextSibling),J=d.nextSibling;return Q(x,F(at,{children:"History | Conduit"}),U,P),Q(x,F(Ee,{label:"Import",onClick:()=>A(!0)}),X,K),Q(x,F(ft,{get isOpen(){return re()},setIsOpen:o=>{console.log(o,"setIsOpen"),A(o)}}),_e,xe),Q(x,F(Ee,{label:"Export",onClick:D}),l,u),Q(x,F(Ee,{label:"Clear",onClick:()=>w(!0)}),p,S),Q(x,F(Qe,{title:"Delete history?",get isOpen(){return _()},setIsOpen:w,get children(){var o=Ce(St),h=o.firstChild,c=h.nextSibling,L=c.firstChild,[y,T]=oe(L.nextSibling),$=y.nextSibling,H=$.firstChild,[R,ae]=oe(H.nextSibling),ie=R.nextSibling,[ye,I]=oe(ie.nextSibling);return Q(c,F(He,{class:"ml-2",get value(){return s()},onInput:ce=>{de(!1),e(ce)},type:"text",get errorMessage(){return s()!=="DELETE"&&N()?"Must type DELETE to confirm":""},placeholder:"DELETE",name:"Type DELETE to confirm",get validationState(){return s()!=="DELETE"?"invalid":"valid"}}),y,T),Q($,F(Ee,{label:"Cancel",onClick:()=>w(!1)}),R,ae),Q($,F(Ee,{label:"Delete",class:"ml-2",onClick:()=>{de(!0),s()==="DELETE"&&(r(),w(!1))}}),ye,I),o}}),b,B),Q(x,F(He,{onInput:o=>Y(o),class:"my-2 mx-auto",placeholder:"Search..."}),d,m),Q(J,F(Fe,{get when(){return le()},get children(){return[F(nt,{get each(){return le()},children:o=>F(it,{get v(){return{...o,url:`/watch?v=${Ve(o)}`}}})}),(()=>{var o=Ce(bt);return qe(h=>g(h),o),o})()]}})),x})()}export{jt as default};
//# sourceMappingURL=history-1CpmRNxz.js.map
